{% extends 'base.html' %}

{% block title %}Feed - User Panel{% endblock %}

{% block content %}

<div class="p-6 lg:p-8">

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            {% if page_name %}
            <span>{{ page_name }}</span>
            {% else %}
            <span>Page Feed</span>
            {% endif %}
            <span class="relative flex h-3 w-3">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
            </span>
        </h1>
        <p class="text-gray-500 mt-2">Facebook Page posts with copyable Post IDs</p>
    </div>

    <!-- Create Post -->
    <div class="mb-8 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <button
            onclick="document.getElementById('create-post-form').classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180');"
            class="w-full flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors duration-200">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </div>
                <span class="text-lg font-semibold text-gray-800">Create Post</span>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>

        <div id="create-post-form" class="hidden border-t border-gray-100">
            <form action="{% url 'create_post' %}" method="post" enctype="multipart/form-data" class="p-6">
                {% csrf_token %}

                <!-- Message -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea name="message" rows="4" placeholder="What's on your mind?"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none text-sm"></textarea>
                </div>

                <!-- Image Attachment -->
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Image (optional)</label>
                    <div class="flex items-center gap-4">
                        <label
                            class="cursor-pointer flex items-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all duration-200">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            <span class="text-sm text-gray-500">Choose Image</span>
                            <input type="file" name="image" accept="image/*" class="hidden"
                                onchange="previewImage(this)">
                        </label>
                        <span id="file-name" class="text-xs text-gray-400"></span>
                    </div>
                    <div id="image-preview" class="mt-3 hidden">
                        <img id="preview-img" src="" alt="Preview"
                            class="h-32 rounded-lg object-cover border border-gray-200">
                        <button type="button" onclick="clearImage()"
                            class="mt-1 text-xs text-red-500 hover:text-red-700">Remove</button>
                    </div>
                </div>

                <!-- Submit -->
                <button type="submit"
                    class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
                    Publish Post
                </button>
            </form>
        </div>
    </div>

    <!-- Error State -->
    {% if error %}
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-700">{{ error }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Posts Grid -->
    {% if posts %}
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for post in posts %}
        <div
            class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col">

            <!-- Post Image -->
            {% if post.full_picture %}
            <div class="w-full h-48 overflow-hidden">
                <img src="{{ post.full_picture }}" alt="Post image"
                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
            </div>
            {% endif %}

            <!-- Post Content -->
            <div class="p-5 flex-1 flex flex-col">

                <!-- Message -->
                {% if post.message %}
                <p class="text-gray-700 text-sm leading-relaxed mb-4 flex-1 whitespace-normal break-words">
                    {{ post.message|truncatewords:40 }}
                </p>
                {% else %}
                <p class="text-gray-400 italic text-sm mb-4 flex-1">[No message]</p>
                {% endif %}

                <!-- Date -->
                {% if post.created_time %}
                <div class="flex items-center text-xs text-gray-400 mb-4">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    {{ post.created_time }}
                </div>
                {% endif %}

                <!-- Post ID & Actions -->
                <div class="border-t border-gray-100 pt-3 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <span class="text-xs text-gray-400 whitespace-nowrap">Post ID:</span>
                        <code id="post-id-{{ forloop.counter }}"
                            class="text-xs bg-gray-100 px-2 py-1 rounded font-mono text-gray-600 truncate block">{{ post.id }}</code>
                    </div>
                    <button onclick="copyPostId('post-id-{{ forloop.counter }}', this)"
                        class="flex-shrink-0 flex items-center gap-1 text-xs px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors duration-200 font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        Copy
                    </button>
                </div>

                <!-- Link to original post -->
                {% if post.permalink_url %}
                <a href="{{ post.permalink_url }}" target="_blank" rel="noopener noreferrer"
                    class="mt-3 text-center text-xs px-3 py-1.5 bg-gray-50 text-gray-500 rounded-lg hover:bg-gray-100 hover:text-gray-700 transition-colors duration-200 font-medium block">
                    View on Facebook â†’
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% elif not error %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 mb-6">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                </path>
            </svg>
        </div>
        <h3 class="text-xl font-medium text-gray-900 mb-2">No Posts Found</h3>
        <p class="text-gray-500 max-w-md mx-auto">Your Facebook Page has no posts yet, or the API returned an empty
            feed.</p>
    </div>
    {% endif %}
</div>

<script>
    function previewImage(input) {
        const preview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const fileName = document.getElementById('file-name');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
            fileName.textContent = input.files[0].name;
        }
    }

    function clearImage() {
        const preview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const fileName = document.getElementById('file-name');
        const fileInput = document.querySelector('input[name="image"]');

        previewImg.src = '';
        preview.classList.add('hidden');
        fileName.textContent = '';
        fileInput.value = '';
    }

    function copyPostId(elementId, button) {
        const el = document.getElementById(elementId);
        const text = el.textContent.trim();

        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Copied!
            `;
            button.classList.remove('bg-blue-50', 'text-blue-600', 'hover:bg-blue-100');
            button.classList.add('bg-green-50', 'text-green-600');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('bg-green-50', 'text-green-600');
                button.classList.add('bg-blue-50', 'text-blue-600', 'hover:bg-blue-100');
            }, 2000);
        }).catch(() => {
            // Fallback for older browsers
            const range = document.createRange();
            range.selectNodeContents(el);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            document.execCommand('copy');
            sel.removeAllRanges();
        });
    }
</script>

{% endblock %}